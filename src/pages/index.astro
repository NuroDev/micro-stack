---
import Document from '../layouts/Document.astro';
import Comment from '../components/Comment.astro';
import CommentForm from '../components/CommentForm.astro';
import { db } from '../utils/db';
import { comments } from '../models/schema';

if (Astro.request.method === 'POST') {
	const data = await Astro.request.formData();
	const author = data.get('author');
	const content = data.get('content');
	await db.insert(comments).values({
		author: author as string,
		content: content as string,
	});
}

const cms = await db.query.comments.findMany();
---

<Document>
	<main class='mx-auto my-8 max-w-2xl px-4'>
		<h1 class='mb-6 text-2xl font-bold text-gray-900'>Comments</h1>
		<ul class='list-none space-y-4'>
			{cms.map((comment) => <Comment comment={comment} />)}
		</ul>
		<CommentForm />
	</main>
</Document>
